<!-- views/frontend/blog.ejs -->
<%- include("./layouts/header.ejs") %>

<!-- Inner Banner -->
<section class="inner-banner">
  <div class="container">
    <div class="row align-items-center justify-content-around">
      <div class="col-lg-6 col-md-6 col-12 text-lg-start text-md-start text-sm-center text-center mb-sm-3 mb-3">
        <div class="inner-banner-heading">
          <h1 class="mb-0">Our Blog</h1>
        </div>
      </div>
      <div class="col-lg-6 col-md-6 col-12 text-lg-end text-md-end text-sm-center text-center">
        <div class="breadcrumbs">
          <ul>
            <li><a href="/">HOME</a></li>
            <li><i class="fa-solid fa-chevron-right mx-2"></i></li>
            <li><a href="/blog" class="active">BLOG</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Blog Section -->
<section class="blog-section ptb-90">
  <div class="container">
    <div class="row">

      <% if (blogs && blogs.length > 0) { %>
        <% blogs.forEach(blog => { %>

          <!-- Safe tags handling -->
          <% 
            let tagsArray = [];
            if (blog.tags) {
              if (Array.isArray(blog.tags)) {
                tagsArray = blog.tags;
              } else if (typeof blog.tags === 'string') {
                try { tagsArray = JSON.parse(blog.tags); } 
                catch { tagsArray = blog.tags.split(',').map(t => t.trim()); }
                if (!Array.isArray(tagsArray)) tagsArray = [];
              }
            }
          %>

          <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12 col-12 mb-4">
            <div class="blog-box shadow-sm rounded overflow-hidden h-100 d-flex flex-column">
              
              <!-- Blog Image -->
              <a href="/blog/<%= blog.id %>" class="blog-img d-block">
                <% if (blog.image) { %>
                  <img src="/uploads/<%= blog.image %>" 
                       alt="<%= blog.title %>" 
                       class="img-fluid w-100"
                       style="height: 220px; object-fit: cover;">
                <% } else { %>
                  <img src="/front-assets/images/blog1.png" 
                       alt="Default Blog Image" 
                       class="img-fluid w-100"
                       style="height: 220px; object-fit: cover;">
                <% } %>
              </a>

              <!-- Blog Content -->
              <div class="p-4 flex-grow-1 d-flex flex-column">
                <a href="/blog/<%= blog.id %>" class="text-decoration-none">
                  <h5 class="fw-bold text-dark mb-2"><%= blog.title %></h5>
                </a>

                <!-- Date -->
                <p class="text-muted small mb-2">
                  <i class="far fa-calendar-alt me-2"></i>
                  <%= new Date(blog.created_at).toLocaleDateString('en-US', { 
                      weekday: 'long', 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                  }) %>
                </p>

                <!-- Tags -->
                <% if (tagsArray.length > 0) { %>
                  <div class="mb-3">
                    <% tagsArray.slice(0, 4).forEach(tag => { %>
                      <span class="badge bg-primary rounded-pill me-1 mb-1"><%= tag %></span>
                    <% }) %>
                    <% if (tagsArray.length > 4) { %>
                      <span class="badge bg-light text-dark">+<%= tagsArray.length - 4 %></span>
                    <% } %>
                  </div>
                <% } %>

                <!-- Excerpt -->
                <p class="text-muted flex-grow-1">
                  <% 
                    const textOnly = blog.content.replace(/<[^>]*>/g, ''); // Strip HTML
                    const excerpt = textOnly.length > 120 
                      ? textOnly.substring(0, 120) + '...' 
                      : textOnly;
                  %>
                  <%= excerpt %>
                </p>

                <!-- Read More Button -->
                <div class="mt-auto">
                  <a href="/blog/<%= blog.id %>" class="btn btn-primary blue-btn btn-sm px-4">
                    Read More
                  </a>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-12 text-center py-5">
          <h4>No blogs available yet.</h4>
          <p class="text-muted">Check back soon for updates!</p>
        </div>
      <% } %>

    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.totalPages > 1) { %>
      <nav aria-label="Page navigation" class="mt-5">
        <ul class="pagination justify-content-center">

          <!-- Previous -->
          <li class="page-item <%= !pagination.hasPrev ? 'disabled' : '' %>">
            <a class="page-link" href="<%= pagination.baseUrl %>?page=<%= pagination.current - 1 %>" 
               tabindex="<%= !pagination.hasPrev ? '-1' : '' %>">
              Previous
            </a>
          </li>

          <!-- Page Numbers -->
          <% for(let i = 1; i <= pagination.totalPages; i++) { %>
            <li class="page-item <%= i === pagination.current ? 'active' : '' %>">
              <a class="page-link" href="<%= pagination.baseUrl %>?page=<%= i %>"><%= i %></a>
            </li>
          <% } %>

          <!-- Next -->
          <li class="page-item <%= !pagination.hasNext ? 'disabled' : '' %>">
            <a class="page-link" href="<%= pagination.baseUrl %>?page=<%= pagination.current + 1 %>"
               tabindex="<%= !pagination.hasNext ? '-1' : '' %>">
              Next
            </a>
          </li>
        </ul>
      </nav>
    <% } %>

  </div>
</section>

<%- include("./layouts/footer.ejs") %>